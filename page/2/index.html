<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fuxyzz.github.io","root":"/","scheme":"Mist","version":"8.0.0-rc.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="fuxyzz&#39;s blog">
<meta property="og:url" content="https://fuxyzz.github.io/page/2/index.html">
<meta property="og:site_name" content="fuxyzz&#39;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="fuxyzz">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://fuxyzz.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>fuxyzz's blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before, .use-motion .logo-line-after {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line-before"></i>
      <h1 class="site-title">fuxyzz's blog</h1>
      <i class="logo-line-after"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">fuxyzz</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


      <div class="main-inner">
        

        <div class="content index posts-expand">
          
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/10/19/Java%E4%B8%AD%E7%9A%84retry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/19/Java%E4%B8%AD%E7%9A%84retry/" class="post-title-link" itemprop="url">Java中的retry</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-19 11:38:44" itemprop="dateCreated datePublished" datetime="2020-10-19T11:38:44+08:00">2020-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>最近在看线程池源码的时候看到有关阻塞队列源码中使用了 <em>retry</em> ，有点懵逼，查阅资料总结一下。</p>
<p><em>retry</em> 是作用于循环中，用于提前中断循环，可以搭配 <em>continue</em> 和 <em>break</em> 使用。使用时在循环之前声明 <em>retry:</em> ，在需要中断的地方使用 <em>break retry</em> 或者 <em>continue retry</em>。看起来很像goto。</p>
<p>搭配continue：中断整个嵌套循环循环，从 <em>retry:</em> 标记的循环继续执行，注意这里可能有坑，你标记写在第几层循环，就是从哪里开始。</p>
<p>搭配break：中断标记开始的循环，注意标记外层的循环继续执行。</p>
<h3 id="code"><a href="#code" class="headerlink" title="code"></a>code</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    &#x2F;&#x2F;retry写最外层循环</span><br><span class="line">    public static void testBreak() &#123;</span><br><span class="line">        retry:</span><br><span class="line">        for (int i &#x3D; 0; i &lt; 3; i++) &#123;</span><br><span class="line">            for (int j &#x3D; 0; j &lt; 3; j++) &#123;</span><br><span class="line">                for (int k &#x3D; 0; k &lt; 3; k++) &#123;</span><br><span class="line">                    System.out.println(i + &quot; &quot; + j + &quot; &quot; + k);</span><br><span class="line">                    if (k &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                        break retry;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;*</span><br><span class="line">    输出：</span><br><span class="line">    0 0 0</span><br><span class="line">    0 0 1</span><br><span class="line">    *&#x2F;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;retry写第二层循环</span><br><span class="line">    public static void testBreak2() &#123;</span><br><span class="line">&#x2F;&#x2F;        retry:</span><br><span class="line">        for (int i &#x3D; 0; i &lt; 3; i++) &#123;</span><br><span class="line">            retry:</span><br><span class="line">            for (int j &#x3D; 0; j &lt; 3; j++) &#123;</span><br><span class="line">                for (int k &#x3D; 0; k &lt; 3; k++) &#123;</span><br><span class="line">                    System.out.println(i + &quot; &quot; + j + &quot; &quot; + k);</span><br><span class="line">                    if (k &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                        break retry;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;*</span><br><span class="line">    输出：</span><br><span class="line">    0 0 0</span><br><span class="line">    0 0 1</span><br><span class="line">    1 0 0</span><br><span class="line">    1 0 1</span><br><span class="line">    2 0 0</span><br><span class="line">    2 0 1</span><br><span class="line">    *&#x2F;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;retry写最外层循环</span><br><span class="line">    public static void testContinue1() &#123;</span><br><span class="line">        retry:</span><br><span class="line">        for (int i &#x3D; 0; i &lt; 5; i++) &#123;</span><br><span class="line">            for (int j &#x3D; 0; j &lt; 5; j++) &#123;</span><br><span class="line">                for (int k &#x3D; 0; k &lt; 5; k++) &#123;</span><br><span class="line">                    System.out.println(i + &quot; &quot; + j + &quot; &quot; + k);</span><br><span class="line">                    if (k &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                        continue retry;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;*</span><br><span class="line">    输出：</span><br><span class="line">    0 0 0</span><br><span class="line">    0 0 1</span><br><span class="line">    1 0 0</span><br><span class="line">    1 0 1</span><br><span class="line">    2 0 0</span><br><span class="line">    2 0 1</span><br><span class="line">    *&#x2F;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;retry写第二层循环</span><br><span class="line">    public static void testContinue2() &#123;</span><br><span class="line">&#x2F;&#x2F;        retry:</span><br><span class="line">        for (int i &#x3D; 0; i &lt; 3; i++) &#123;</span><br><span class="line">            retry:</span><br><span class="line">            for (int j &#x3D; 0; j &lt; 3; j++) &#123;</span><br><span class="line">                for (int k &#x3D; 0; k &lt; 3; k++) &#123;</span><br><span class="line">                    System.out.println(i + &quot; &quot; + j + &quot; &quot; + k);</span><br><span class="line">                    if (k &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                        continue retry;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;*</span><br><span class="line">    输出：</span><br><span class="line">    0 0 0</span><br><span class="line">    0 0 1</span><br><span class="line">    0 1 0</span><br><span class="line">    0 1 1</span><br><span class="line">    0 2 0</span><br><span class="line">    0 2 1</span><br><span class="line">    1 0 0</span><br><span class="line">    1 0 1</span><br><span class="line">    1 1 0</span><br><span class="line">    1 1 1</span><br><span class="line">    1 2 0</span><br><span class="line">    1 2 1</span><br><span class="line">    2 0 0</span><br><span class="line">    2 0 1</span><br><span class="line">    2 1 0</span><br><span class="line">    2 1 1</span><br><span class="line">    2 2 0</span><br><span class="line">    2 2 1</span><br><span class="line">    *&#x2F;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/10/15/Java%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/15/Java%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">Java双亲委派模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-15 11:24:40" itemprop="dateCreated datePublished" datetime="2020-10-15T11:24:40+08:00">2020-10-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>双亲委派模型是指当类加载器收到类加载任务时，会先交由自己的父类加载器去尝试加载，最终会传递到BootstrapClassLoader，只有当父类加载器无法加载任务时才会尝试自己加载。</p>
<h3 id="常见类加载器"><a href="#常见类加载器" class="headerlink" title="常见类加载器"></a>常见类加载器</h3><p>BootstrapClassLoader（启动类加载器）：负责核心类库的加载，rt.jar，java.lang.*，JVM_HOME/lib目录下的，构造ExtClassLoader和AppClassLoader。</p>
<p>ExtClassLoader（拓展类加载器）：负责加载jre/lib/ext的jar。</p>
<p>AppClassLoader（系统类加载器）：加载应用程序的主函数类。</p>
<h3 id="双亲委派模型的打破"><a href="#双亲委派模型的打破" class="headerlink" title="双亲委派模型的打破"></a>双亲委派模型的打破</h3><p>Java SPI机制：SPI全称Service Provider Interface，用于接入产商自定义组件，例如JDBC。SPI的思想是系统抽象的各个模块有多种实现方案，例如JDBC，日志模块等。面向对象中，我们倾向于基于接口编程，模块直接不对实现类进行硬编码，否则会破坏开闭原则。为了能在模块装配的时候不需要在程序中显示声明，需要服务发现机制，SPI就是提供这样一个服务。</p>
<p>SPI的约定：当服务提供者提供服务接口后，在jar包下的META-INF/services/目录同时创建一个以服务接口命名的具体实现类文件。当外部程序装配模块的时候，能够以META-INF/services/里的配置文件找到具体的实现类并实例化。jdk中提供了java.util.ServiceLoader进行实现。</p>
<p>以JDBC为例，我们通常用以下方式获取数据库连接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String url &#x3D; &quot;jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;testdb&quot;;    </span><br><span class="line">Connection conn &#x3D; java.sql.DriverManager.getConnection(url, &quot;name&quot;, &quot;password&quot;);</span><br></pre></td></tr></table></figure>

<p>getConnection()继续调用了重载的getConnection方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static Connection getConnection(String url,</span><br><span class="line">    java.util.Properties info) throws SQLException &#123;</span><br><span class="line"></span><br><span class="line">    return (getConnection(url, info, Reflection.getCallerClass()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重载的方法，省略若干代码，看注释可以知道此时得到的callerCL为null，那么就会执行Thread.currentThread().getContextClassLoader()并赋值给callerCL，而且后面调用isDriverAllowed(aDriver.driver, callerCL)就是使用此时获取的类加载器进行类的加载。于是重点就是停留在Thread.currentThread().getContextClassLoader()。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static Connection getConnection(</span><br><span class="line">    String url, java.util.Properties info, Class&lt;?&gt; caller) throws SQLException &#123;</span><br><span class="line">    &#x2F;*</span><br><span class="line">     * When callerCl is null, we should check the application&#39;s</span><br><span class="line">     * (which is invoking this class indirectly)</span><br><span class="line">     * classloader, so that the JDBC driver class outside rt.jar</span><br><span class="line">     * can be loaded from here.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    ClassLoader callerCL &#x3D; caller !&#x3D; null ? caller.getClassLoader() : null;</span><br><span class="line">    synchronized(DriverManager.class) &#123;</span><br><span class="line">        &#x2F;&#x2F; synchronize loading of the correct classloader.</span><br><span class="line">        if (callerCL &#x3D;&#x3D; null) &#123;</span><br><span class="line">            callerCL &#x3D; Thread.currentThread().getContextClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    for(DriverInfo aDriver : registeredDrivers) &#123;</span><br><span class="line">        &#x2F;&#x2F; If the caller does not have permission to load the driver then</span><br><span class="line">        &#x2F;&#x2F; skip it.</span><br><span class="line">        if(isDriverAllowed(aDriver.driver, callerCL)) &#123;</span><br><span class="line">            ...</span><br><span class="line">            ...</span><br><span class="line">            ...</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            ...</span><br><span class="line">            ...</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static boolean isDriverAllowed(Driver driver, ClassLoader classLoader) &#123;</span><br><span class="line">    boolean result &#x3D; false;</span><br><span class="line">    if(driver !&#x3D; null) &#123;</span><br><span class="line">        Class&lt;?&gt; aClass &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            aClass &#x3D;  Class.forName(driver.getClass().getName(), true, classLoader);</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            result &#x3D; false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         result &#x3D; ( aClass &#x3D;&#x3D; driver.getClass() ) ? true : false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public ClassLoader getContextClassLoader() &#123;</span><br><span class="line">    if (contextClassLoader &#x3D;&#x3D; null)</span><br><span class="line">        return null;</span><br><span class="line">    SecurityManager sm &#x3D; System.getSecurityManager();</span><br><span class="line">    if (sm !&#x3D; null) &#123;</span><br><span class="line">        ClassLoader.checkClassLoaderPermission(contextClassLoader,</span><br><span class="line">                                               Reflection.getCallerClass());</span><br><span class="line">    &#125;</span><br><span class="line">    return contextClassLoader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下getContextClassLoader方法，发现仅仅只是简单的校验就获取了。我们回到一开始的java.sql.DriverManager.getConnection(url, “name”, “password”)，这里的DriverManager，我们看一下它的初始化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private DriverManager()&#123;&#125;</span><br><span class="line"></span><br><span class="line">static &#123;</span><br><span class="line">    loadInitialDrivers();</span><br><span class="line">    println(&quot;JDBC DriverManager initialized&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static void loadInitialDrivers() &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    for (String aDriver : driversList) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            println(&quot;DriverManager.Initialize: loading &quot; + aDriver);</span><br><span class="line">            Class.forName(aDriver, true,</span><br><span class="line">                    ClassLoader.getSystemClassLoader());</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            println(&quot;DriverManager.Initialize: load failed: &quot; + ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static ClassLoader getSystemClassLoader() &#123;</span><br><span class="line">    initSystemClassLoader();</span><br><span class="line">    if (scl &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    SecurityManager sm &#x3D; System.getSecurityManager();</span><br><span class="line">    if (sm !&#x3D; null) &#123;</span><br><span class="line">        checkClassLoaderPermission(scl, Reflection.getCallerClass());</span><br><span class="line">    &#125;</span><br><span class="line">    return scl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造方法被private修饰阻止了实例化，那么看一下静态代码块的loadInitialDrivers方法，省略若干代码，我们看一下ClassLoader.getSystemClassLoader()，发现了initSystemClassLoader()，继续往下看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static synchronized void initSystemClassLoader() &#123;</span><br><span class="line">    if (!sclSet) &#123;</span><br><span class="line">        if (scl !&#x3D; null)</span><br><span class="line">            throw new IllegalStateException(&quot;recursive invocation&quot;);</span><br><span class="line">        sun.misc.Launcher l &#x3D; sun.misc.Launcher.getLauncher();</span><br><span class="line">        if (l !&#x3D; null) &#123;</span><br><span class="line">            Throwable oops &#x3D; null;</span><br><span class="line">            scl &#x3D; l.getClassLoader();</span><br><span class="line">            try &#123;</span><br><span class="line">                scl &#x3D; AccessController.doPrivileged(</span><br><span class="line">                    new SystemClassLoaderAction(scl));</span><br><span class="line">            &#125; catch (PrivilegedActionException pae) &#123;</span><br><span class="line">                oops &#x3D; pae.getCause();</span><br><span class="line">                if (oops instanceof InvocationTargetException) &#123;</span><br><span class="line">                    oops &#x3D; oops.getCause();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (oops !&#x3D; null) &#123;</span><br><span class="line">                if (oops instanceof Error) &#123;</span><br><span class="line">                    throw (Error) oops;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; wrap the exception</span><br><span class="line">                    throw new Error(oops);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sclSet &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Launcher() &#123;</span><br><span class="line">    Launcher.ExtClassLoader var1;</span><br><span class="line">    try &#123;</span><br><span class="line">        var1 &#x3D; Launcher.ExtClassLoader.getExtClassLoader();</span><br><span class="line">    &#125; catch (IOException var10) &#123;</span><br><span class="line">        throw new InternalError(&quot;Could not create extension class loader&quot;, var10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.loader &#x3D; Launcher.AppClassLoader.getAppClassLoader(var1);</span><br><span class="line">    &#125; catch (IOException var9) &#123;</span><br><span class="line">        throw new InternalError(&quot;Could not create application class loader&quot;, var9);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Thread.currentThread().setContextClassLoader(this.loader);</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里就是实现的关键，注意initSystemClassLoader的以下代码段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sun.misc.Launcher l &#x3D; sun.misc.Launcher.getLauncher();</span><br><span class="line"></span><br><span class="line">scl &#x3D; l.getClassLoader();</span><br><span class="line">try &#123;</span><br><span class="line">    scl &#x3D; AccessController.doPrivileged(</span><br><span class="line">        new SystemClassLoaderAction(scl));</span><br><span class="line">&#125; catch (PrivilegedActionException pae) &#123;</span><br><span class="line">    oops &#x3D; pae.getCause();</span><br><span class="line">    if (oops instanceof InvocationTargetException) &#123;</span><br><span class="line">        oops &#x3D; oops.getCause();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下getLauncher()</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public Launcher() &#123;</span><br><span class="line">    Launcher.ExtClassLoader var1;</span><br><span class="line">    try &#123;</span><br><span class="line">        var1 &#x3D; Launcher.ExtClassLoader.getExtClassLoader();</span><br><span class="line">    &#125; catch (IOException var10) &#123;</span><br><span class="line">        throw new InternalError(&quot;Could not create extension class loader&quot;, var10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.loader &#x3D; Launcher.AppClassLoader.getAppClassLoader(var1);</span><br><span class="line">    &#125; catch (IOException var9) &#123;</span><br><span class="line">        throw new InternalError(&quot;Could not create application class loader&quot;, var9);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Thread.currentThread().setContextClassLoader(this.loader);</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现这里先获取了当前的系统加载器，然后将系统加载器，然后将系统加载器作为线程上下文加载器的父类，相当于构造链表一样。我们再看一下new SystemClassLoaderAction(scl)，发现这个类居然有个run方法，而且是使用java.system.class.loader作为实现的线程上下文加载器。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SystemClassLoaderAction(ClassLoader parent) &#123;</span><br><span class="line">    this.parent &#x3D; parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public ClassLoader run() throws Exception &#123;</span><br><span class="line">    String cls &#x3D; System.getProperty(&quot;java.system.class.loader&quot;);</span><br><span class="line">    if (cls &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Constructor&lt;?&gt; ctor &#x3D; Class.forName(cls, true, parent)</span><br><span class="line">        .getDeclaredConstructor(new Class&lt;?&gt;[] &#123; ClassLoader.class &#125;);</span><br><span class="line">    ClassLoader sys &#x3D; (ClassLoader) ctor.newInstance(</span><br><span class="line">        new Object[] &#123; parent &#125;);</span><br><span class="line">    Thread.currentThread().setContextClassLoader(sys);</span><br><span class="line">    return sys;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里我们可以得出结论：对于SPI，通过配置文件java.system.class.loader的方式实现了额外的线程上下文加载器并用于加载SPI组件，于是就打破了双亲委派模型。其实我们平时实现自定义类加载器的方式也是打破双亲委派模型，我们通过重写findClass（1.2之前是通过重写loadClass）阻止使用双亲委派模型。</p>
<p>ps：为什么要使用自定义类加载器？因为系统类加载器只会加载指定目录下的class文件，想加载自己的文件就可以通过自定义ClassLoader，可以用于文件改动后不想重启Java程序的热加载。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/10/14/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%EF%BC%88JMM%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/14/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%EF%BC%88JMM%EF%BC%89/" class="post-title-link" itemprop="url">Java内存模型（JMM）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-14 09:28:42" itemprop="dateCreated datePublished" datetime="2020-10-14T09:28:42+08:00">2020-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>Java Memory Model，简称JMM，翻译为Java内存模型。具体是指Java中线程的工作方式。</p>
<p>前置知识：线程有自己的工作内存，各个线程之间是不共享自己工作内存数据的，线程之间也是不能直接进行通信。</p>
<p>并发情况下，多个线程可能同时读取了同个变量（拷贝了副本），当这些线程同时进行修改的时候，其他工作线程对变量不可见，这就会导致出现并发修改同个变量错误的问题。为了解决这个问题，提出了Java内存模型。</p>
<h3 id="工作流程图"><a href="#工作流程图" class="headerlink" title="工作流程图"></a>工作流程图</h3><p><img src="https://cdn.jsdelivr.net/gh/fuxyzz/cdn/images/jmm.png" alt="avatar"></p>
<p>如图所示，多线程并发共享变量的时候，用一系列的原子操作来进行。</p>
<h3 id="JMM中的数据原子操作"><a href="#JMM中的数据原子操作" class="headerlink" title="JMM中的数据原子操作"></a>JMM中的数据原子操作</h3><p>read：从主内存中读取数据</p>
<p>load：将read读取到的数据写入线程的工作内存中</p>
<p>use：从工作内存中读取数据进行计算</p>
<p>assign：将计算好的值重新写入工作内存中</p>
<p>store：将工作内存中的数据写入主内存</p>
<p>write：将store写入的值赋值给主内存中的变量</p>
<p>lock：将主内存变量加锁，标志为独占状态</p>
<p>unlock：将主内存变量解锁，标志为其他线程可以锁定该变量</p>
<p>lock和unlock是早期解决不同线程之间变量同步的方案，通过加锁的方式将并发操作变为串行化操作来实现。在当今服务器CPU核心很多的情况下，这种操作会大大降低效率。后续的方案是MESI缓存一致性协议，CPU通过总线嗅探机制感知数据的变化从而将自己的缓存数据失效来实现，同时为了解决多个线程同时并发修改的问题，锁定变量操作改为在store的时候进行加锁，降低锁的力度，更高效。</p>
<p>Java中是通过volatile关键字修饰变量来达到的。注意volatile不能保证原子性，假设有两个线程获取了变量i，都进行i++ 操作，线程1与线程2都执行到assign，然后线程1先执行store，此时由于总线嗅探机制，线程2会重新从主存中获取i的值，然后执行store和write，相当于没有进行i++ 操作，这也是因为i++并不是一个原子操作的原因。</p>
<h3 id="高并发三大特性"><a href="#高并发三大特性" class="headerlink" title="高并发三大特性"></a>高并发三大特性</h3><p>高并发三大特性：原子性，有序性，一致性（可见性）。</p>
<p>volatile保证了有序性和一致性，有序性是通过禁止指令重排序实现，一致性通过底层的MESI缓存一致性协议实现。</p>
<p>Synchronized保证了原子性，有序性和一致性。原子性通过monitorenter和monitorexit实现，底层是调用了JMM中原子操作lock和unlock，可以理解是由于锁将代码串行化执行保证了原子性。一致性是通过在unlock之前必须先将变量同步回主存（即执行store和write）。有序性与原子性一样也是通过串行化执行来实现。</p>
<h3 id="happends-before（先行发生）原则"><a href="#happends-before（先行发生）原则" class="headerlink" title="happends-before（先行发生）原则"></a>happends-before（先行发生）原则</h3><p>程序次序规则：一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作</p>
<p>锁定规则：一个unLock操作先行发生于后面对同一个锁的lock操作</p>
<p>volatile变量规则：对一个变量的写操作先行发生于后面对这个变量的读操作</p>
<p>传递规则：如果操作A先行发生于操作B，而操作B又先行发生于操作C，则可以得出操作A先行发生于操作C</p>
<p>线程启动规则：Thread对象的start()方法先行发生于此线程的每个一个动作</p>
<p>线程中断规则：对线程interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生</p>
<p>线程终结规则：线程中所有的操作都先行发生于线程的终止检测，我们可以通过Thread.join()方法结束、Thread.isAlive()的返回值手段检测到线程已经终止执行</p>
<p>对象终结规则：一个对象的初始化完成先行发生于他的finalize()方法的开始</p>
<p>这8条规则适用单线程，jvm会将没有数据依赖的语句进行指令重排序，多线程可能会出现问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/10/09/Java%E4%B8%AD%E7%9A%84%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/09/Java%E4%B8%AD%E7%9A%84%E9%94%81/" class="post-title-link" itemprop="url">Java中的锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-09 15:02:18" itemprop="dateCreated datePublished" datetime="2020-10-09T15:02:18+08:00">2020-10-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/lock/" itemprop="url" rel="index"><span itemprop="name">lock</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="乐观锁和悲观锁"><a href="#乐观锁和悲观锁" class="headerlink" title="乐观锁和悲观锁"></a>乐观锁和悲观锁</h1><p>在了解java中的锁之前，我们需要先了解乐观锁和悲观锁。</p>
<p>悲观锁是指数据并发的时候，认为在使用数据的时候会有其他线程来修改数据，因此在获取数据的时候会进行加锁。</p>
<p>乐观锁是指数据并发的时候，乐观锁认为在使用数据的时候不会有其他线程来修改数据，因此只在更新数据的时候判断有没有其他线程更新了数据（ABA问题可以用时间戳或者版本号解决）。</p>
<p>应用场景：乐观锁适合读多写少，不加锁的特点使得性能能够大幅提升。悲观锁适合写多读少，先加锁可以保证写操作数据正确。</p>
<h1 id="java中的锁实现"><a href="#java中的锁实现" class="headerlink" title="java中的锁实现"></a>java中的锁实现</h1><h3 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h3><p>通过无锁编程，常用的是CAS算法实现，例如并发包下的Atomic包下的类，例如AtomicInteger，通过CAS自旋实现。</p>
<p>CAS全称Campare And Swap，在不使用锁的情况下实现多线程的变量同步。CAS涉及三个操作：</p>
<p>（1）读取需要读写的内存值</p>
<p>（2）比较值</p>
<p>（3）写入新值</p>
<p>底层操作系统通过类似原语的原子操作保证比较和写入是一个原子操作，一般情况下写入是不断重试的操作。</p>
<p>举个例子：AtomicInteger的getAndIncrement方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public final int getAndAddInt(Object var1, long var2, int var4) &#123;</span><br><span class="line">    int var5;</span><br><span class="line">    do &#123;</span><br><span class="line">        var5 &#x3D; this.getIntVolatile(var1, var2);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;自旋直至成功</span><br><span class="line">    while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line">    return var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CAS存在的问题：</p>
<p>（1）CAS会引起ABA问题，JDK从1.5开始提供了AtomicStampedReference类来解决ABA问题。</p>
<p>（2）自旋开销问题，如果长时间CAS操作不成功，会一直自旋，浪费CPU资源。</p>
<p>（3）保证一个共享变量的原子性，不能保证多个变量操作时的原子性。Java从1.5开始JDK提供了AtomicReference类来保证引用对象之间的原子性，可以把多个变量放在一个对象里来进行CAS操作。</p>
<p>关于自旋：唤醒或阻塞一个线程需要操作系统切换CPU，这种状态转换需要耗费处理器的时间，如果同步代码块中的内容非常简单，状态转换时间有可能比用户代码执行时间还要长。很多场景下，同步资源等待锁的情况很少，为了一小段时间去切换线程，非常的得不偿失。如果有多个CPU，能够让两个或以上的线程同时并行的执行，就可以让后请求的线程不阻塞不放弃CPU的执行时间，等待前面的线程是否很快就会释放锁。自旋锁有限制次数，默认是10次，可以用-XX:PreBlockSpin更改，如果达到限制次数没有成功获得锁，就需要阻塞线程（或者说挂起吧）。</p>
<p>自旋锁在JDK1.4.2中引入，使用-XX:+UseSpinning来开启。JDK 6中为默认开启，并且引入了适应性自旋锁。</p>
<p>自适应的意思是自旋的次数不再固定，由上一次在同一个锁上自旋次数及拥有者的状态来决定。如果在同一个锁对象上自旋等待成功获得过锁，并且拥有锁的线程在运行中，那么JVM认为很可能再次成功获取锁，允许将这次的自旋次数提高。如果对于某个锁，自旋很少成功，后面尝试获取这个锁的时候获取失败直接阻塞，不进行自旋操作。</p>
<p>自旋锁常见的锁形式：TicketLock、CLHlock和MCSlock。</p>
<h3 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h3><h3 id="Synchronized"><a href="#Synchronized" class="headerlink" title="Synchronized"></a>Synchronized</h3><p>Synchronized在JDK1.6以前是悲观锁的实现，1.6引入了无锁，偏向锁，轻量级锁，重量级锁。由于无锁是CAS实现的乐观锁，1.6不能单纯的将Synchronized认为是悲观锁。</p>
<p>先探究一下Synchronized实现线程同步的原理。主要依赖两个东西，JAVA对象头和Monitor。</p>
<p>JAVA对象头在Hotspot虚拟机里包含两部分数据，Mark Word（标记字段），Klass Pointer（类型指针）。</p>
<p>Mark Word：默认存储对象的HashCode，分代年龄，锁标志位信息。存储的都是与对象自身无关的信息，运行期间Mark Word的信息会根据锁状态的不同发生改变。</p>
<p>Klass Pointer：对象指向它类元数据的指针，JVM通过它确定对象是哪个类的实例。</p>
<p>Monitor：一种同步机制，依赖底层操作系统的Mutex Lock（互斥锁）实现线程同步。每个JAVA对象都有一把Monitor锁。Monitor是线程私有的数据结构，每个线程都有Monitor Record列表，同时有全局共享的可用列表。每一个被锁的对象都会和一个Monitor关联，同时Monitor有一个Owner字段存放拥有该锁的线程的唯一标志，表示锁被该线程占用。</p>
<p>锁状态及Mark Word对于标志位</p>
<table>
<thead>
<tr>
<th align="center">锁状态</th>
<th align="center">存储内容</th>
<th align="center">标志位</th>
</tr>
</thead>
<tbody><tr>
<td align="center">无锁</td>
<td align="center">对象HashCode，分代年龄，偏向锁标志位（0）</td>
<td align="center">01</td>
</tr>
<tr>
<td align="center">偏向锁</td>
<td align="center">偏向线程，偏向时间戳，分代年龄，偏向锁标志位（1）</td>
<td align="center">01</td>
</tr>
<tr>
<td align="center">轻量级锁</td>
<td align="center">执行栈中锁记录的指针</td>
<td align="center">00</td>
</tr>
<tr>
<td align="center">重量级锁</td>
<td align="center">指向重量级锁的指针</td>
<td align="center">10</td>
</tr>
<tr>
<td align="center">GC标志</td>
<td align="center">空，没有记录信息</td>
<td align="center">11</td>
</tr>
</tbody></table>
<p>无锁：</p>
<p>多个线程都能访问和修改同一个资源，只有一个成功，底层依赖CAS实现。</p>
<p>偏向锁：</p>
<p>一段同步代码块一直被一个线程访问，那么该线程就会自动获取锁，降低获取的代价。应用的场景是在无多线程竞争的场景下尽量减少不必要的轻量级锁执行，因为执行的过程设计多次的获取和释放CAS原子指令，偏向锁通过更新偏向线程ID的时候执行一次CAS指令即可。</p>
<p>偏向锁只有在其他线程尝试竞争偏向锁的时候释放锁，线程不会主动释放偏向锁。偏向锁释放时机在全局安全点，先暂停拥有偏向锁的线程，判断对象是否处于锁定状态。释放偏向锁后升级为轻量级锁状态。</p>
<p>1.6以后默认开启，可以用-XX:-UseBiasedLocking=false关闭。</p>
<p>轻量级锁：</p>
<p>当锁是偏向锁的时候，被另外的线程访问，偏向锁就会升级为轻量级锁。其他线程会使用自旋锁获取锁资源，提高性能。</p>
<p>代码进入同步块的时候，如果对象的锁状态为无锁状态，JVM在当前线程的栈帧中建立一个Lock Record列表，存储对象目前Mark Word的副本。</p>
<p>存储对象Mark Word副本成功后，使用CAS指针将对象的Mark Word更新为指向Lock Record的指针，将Lock Record的Owner指针指向对象的Mark Word。</p>
<p>如果更新成功，线程就拥有了锁资源。</p>
<p>如果更新失败，JVM先检查对象的Mark Word是否指向当前线程的栈帧，如果是说明当前线程已经拥有了锁资源，继续执行，否则说明处于多线程竞争中。</p>
<p>如果只有一个等待线程，线程通过自旋等待锁资源。如果自旋次数超过限制次数，或者一个线程在持有锁，一个在自旋，此时又有更多线程尝试获取锁资源，则升级为重量级锁。</p>
<p>重量级锁：</p>
<p>Mark Word中存储指向重量级锁的指针，等待的线程都会进入阻塞状态。</p>
<p>结论及注意事项：</p>
<p>（1）锁只能升级不能降级</p>
<p>（2）从上述的描述很容易看出锁是对象级别的，不是所有对象都是同一锁级别的</p>
<p>（3）偏向锁通过对比Mark Word解决锁问题，减少CAS操作</p>
<p>（4）轻量级锁通过CAS操作和自旋解决锁问题，避免线程阻塞和唤醒影响性能</p>
<p>（5）重量级锁将拥有锁以外的线程全部阻塞</p>
<h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p>ReentrantLock底层实现了公平锁和非公平锁，默认使用非公平锁。</p>
<p>公平锁是按申请锁的时间顺序获取锁，进入队列等待获取，公平锁的优点是不会造成饿死现象。缺点是吞吐效率相对非公平锁要低，等待队列中除了第一个线程外其他线程全部阻塞，CPU唤醒阻塞线程的开销比非公平锁要大。</p>
<p>非公平锁是多个线程加锁时直接获取锁，获取不到才会到等待队列中进行排队，如果此时锁刚好可用就无需阻塞直接获取到锁，所以非公平锁可能会出现后申请锁资源却先获取到锁资源的情况。非公平锁的优点是减少唤起线程的开销，整体的吞吐率更高，因为线程有几率不阻塞直接获取锁，CPU不必唤醒所有线程。缺点是处于等待队列中的线程可能会饿死，或者等待很久才会获得锁。</p>
<p>在源码中，公平锁比非公平锁在获取锁的时候多了一个判断，通过hasQueuedPredecessors判断当前线程是否处于队列的头部。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public final boolean hasQueuedPredecessors() &#123;</span><br><span class="line">    &#x2F;&#x2F; The correctness of this depends on head being initialized</span><br><span class="line">    &#x2F;&#x2F; before tail and on head.next being accurate if the current</span><br><span class="line">    &#x2F;&#x2F; thread is first in queue.</span><br><span class="line">    Node t &#x3D; tail; &#x2F;&#x2F; Read fields in reverse initialization order</span><br><span class="line">    Node h &#x3D; head;</span><br><span class="line">    Node s;</span><br><span class="line">    return h !&#x3D; t &amp;&amp;</span><br><span class="line">        ((s &#x3D; h.next) &#x3D;&#x3D; null || s.thread !&#x3D; Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结一下：公平锁是排队，非公平锁是插队。</p>
<h3 id="可重入锁"><a href="#可重入锁" class="headerlink" title="可重入锁"></a>可重入锁</h3><p>可重入锁又名递归锁，指同一个线程在外层方法获取锁的时候，再进入该线程的内层方法会自动获取锁（前提是同一个对象或者class），不会因为之前获取过还没释放而阻塞。Synchronized和ReentrantLock都是可冲入锁，可重入锁可以一定程度上避免死锁。</p>
<h3 id="共享锁和排他锁"><a href="#共享锁和排他锁" class="headerlink" title="共享锁和排他锁"></a>共享锁和排他锁</h3><p>共享锁是指锁可以被多个线程持有，如果线程A对数据Data加了共享锁后，其他线程也只能对Data加共享锁，不能加排他锁。获取共享锁的线程只能读，不能修改Data。</p>
<p>排他锁是指锁只能被一个线程持有，如果给一个数据加上排他锁，其他线程不能对数据再加上任何类型的锁。获得排他锁的线程既可以读也可以写。Synchronized和ReentrantLock都是排他锁。</p>
<p>ReentrantReadWriteLock实现了共享锁和排他锁，内部有两把锁，ReadLock和WriteLock。ReadLock就是读锁，是共享锁的实现，WriteLock是写锁，是排他锁的实现。</p>
<p>在AQS中有个int变量state，表示多少线程获取了锁。在排他锁的情况下，这个变量是0或者1（如果是可重入锁state表示重入的次数），共享锁中就是持有锁的数量。在ReentrantReadWriteLock的实现中，直接将state变量对半切分了，高16位用于统计读锁个数，低16位用于统计写锁个数。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>所有的锁最终都是用到了CAS进行数据保证，甚至利用CAS避免线程阻塞使得从用户态切换到内核态，但是为了尽可能的减少CAS操作（因为涉及到缓存失效，其他线程需要从主存中重新获取，开销挺大），做了其他的一些优化。Synchronized和ReentrantLock效率上在JDK1.6版本以后几乎没有性能的差距，在并发量不高的情况下Synchronized也许效率会更高。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/09/28/leetcode-371/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/28/leetcode-371/" class="post-title-link" itemprop="url">leetcode-371</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-28 12:31:38" itemprop="dateCreated datePublished" datetime="2020-09-28T12:31:38+08:00">2020-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/algorithm/" itemprop="url" rel="index"><span itemprop="name">algorithm</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/algorithm/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、题目描述"><a href="#一、题目描述" class="headerlink" title="一、题目描述"></a>一、题目描述</h3><p><a href="https://leetcode.com/problems/sum-of-two-integers/" target="_blank" rel="noopener">原题链接</a></p>
<h3 id="二、思路"><a href="#二、思路" class="headerlink" title="二、思路"></a>二、思路</h3><p>模拟计算机的加法操作即可，先进行异或操作，再进行进位的操作。这里提一下为什么可以这样做，因为异或的本质是无进位加法，在此之上进行进位操作后就可以得到答案。</p>
<h3 id="三、code"><a href="#三、code" class="headerlink" title="三、code"></a>三、code</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public int getSum(int a, int b) &#123;</span><br><span class="line">    if (b &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        return a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int sum &#x3D; a ^ b;</span><br><span class="line">    &#x2F;&#x2F;进位</span><br><span class="line">    int carry &#x3D; (a &amp; b) &lt;&lt; 1;</span><br><span class="line"></span><br><span class="line">    return getSum(sum, carry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="四、复杂度分析"><a href="#四、复杂度分析" class="headerlink" title="四、复杂度分析"></a>四、复杂度分析</h3><p>时间复杂度：O（1），因为最差就是a和b相等，且二进制全1的情况，int最高是32，是常数级别。</p>
<p>空间复杂度：O（1），尾递归，没有栈的消耗。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/09/22/%E6%B5%8B%E8%AF%95mysql8%E5%9C%A8innodb%E4%B8%8B%E4%B8%8D%E5%90%8C%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E7%9A%84%E9%94%81%E6%83%85%E5%86%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/%E6%B5%8B%E8%AF%95mysql8%E5%9C%A8innodb%E4%B8%8B%E4%B8%8D%E5%90%8C%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E7%9A%84%E9%94%81%E6%83%85%E5%86%B5/" class="post-title-link" itemprop="url">测试mysql8在innodb下不同隔离级别的锁情况</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-22 10:26:55" itemprop="dateCreated datePublished" datetime="2020-09-22T10:26:55+08:00">2020-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/lock/" itemprop="url" rel="index"><span itemprop="name">lock</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>理解mysql在不同隔离级别下的锁情况，用到mysql8.0是因为8.0可以直接看锁的情况，8.0之前不可以。</p>
<h1 id="准备测试数据"><a href="#准备测试数据" class="headerlink" title="准备测试数据"></a>准备测试数据</h1><p>desc看表情况：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; desc student;</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| sno   | int(32)     | NO   | PRI | NULL    |       |</span><br><span class="line">| name  | varchar(32) | NO   |     | NULL    |       |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>看表中的值：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from student;</span><br><span class="line">+-----+------+</span><br><span class="line">| sno | name |</span><br><span class="line">+-----+------+</span><br><span class="line">|   1 | 1    |</span><br><span class="line">|   2 | 2    |</span><br><span class="line">|   3 | 3    |</span><br><span class="line">+-----+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h1 id="RR隔离级别"><a href="#RR隔离级别" class="headerlink" title="RR隔离级别"></a>RR隔离级别</h1><p>在RR隔离级别下，据说mysql解决了幻读：</p>
<p>mysql客户端1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; insert into student values(4,&#39;4&#39;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student;</span><br><span class="line">+-----+------+</span><br><span class="line">| sno | name |</span><br><span class="line">+-----+------+</span><br><span class="line">|   1 | 1    |</span><br><span class="line">|   2 | 2    |</span><br><span class="line">|   3 | 3    |</span><br><span class="line">|   4 | 4    |</span><br><span class="line">+-----+------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>mysql客户端2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from student;</span><br><span class="line">+-----+------+</span><br><span class="line">| sno | name |</span><br><span class="line">+-----+------+</span><br><span class="line">|   1 | 1    |</span><br><span class="line">|   2 | 2    |</span><br><span class="line">|   3 | 3    |</span><br><span class="line">+-----+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>mysql官方8.0的文档有说明这个问题：<a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html</a></p>
<ul>
<li>REPEATABLE READ</li>
</ul>
<p>This is the default isolation level for InnoDB. Consistent reads within the same transaction read the snapshot established by the first read. This means that if you issue several plain (nonlocking) SELECT statements within the same transaction, these SELECT statements are consistent also with respect to each other. See Section 15.7.2.3, “Consistent Nonlocking Reads”.</p>
<p>For locking reads (SELECT with FOR UPDATE or FOR SHARE), UPDATE, and DELETE statements, locking depends on whether the statement uses a unique index with a unique search condition, or a range-type search condition.</p>
<ul>
<li><p>For a unique index with a unique search condition, InnoDB locks only the index record found, not the gap before it.</p>
</li>
<li><p>For other search conditions, InnoDB locks the index range scanned, using gap locks or next-key locks to block insertions by other sessions into the gaps covered by the range. For information about gap locks and next-key locks, see Section 15.7.1, “InnoDB Locking”.</p>
</li>
</ul>
<p>渣翻译：</p>
<p>这是InnoDB默认的隔离级别。<font color='red'>同一事务中的一致性阅读将读取第一次建立的快照</font>，这意味着如果同时请求多个普通（非锁定）语句，则这些select语句彼此之间是保持一致的。（两个客户端开启了事务，如何事务1先读取了一次建立快照，然后客户端2修改了某些行并提交释放了事务，客户端1在事务中重新再读取将还是得到一开始的快照数据，RC级别则不是这样，后面会提到）</p>
<p>对于锁定读取（select中带有for update 或者 for share），update，delete语句，加锁取决于使用的是带有唯一搜索条件且是唯一索引还是范围类型的搜索条件。</p>
<p>提出问题：如果是带唯一条件的，可是没有索引，或者非唯一索引的话会怎样？测试一下。</p>
<h3 id="无索引情况下："><a href="#无索引情况下：" class="headerlink" title="无索引情况下："></a>无索引情况下：</h3><h5 id="mysql客户端1"><a href="#mysql客户端1" class="headerlink" title="mysql客户端1"></a>mysql客户端1</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from student where name&#x3D;2 lock in share mode;</span><br><span class="line">+-----+------+</span><br><span class="line">| sno | name |</span><br><span class="line">+-----+------+</span><br><span class="line">|   2 | 2    |</span><br><span class="line">+-----+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT TRX_ID FROM INFORMATION_SCHEMA.INNODB_TRX  WHERE TRX_MYSQL_THREAD_ID &#x3D; CONNECTION_ID();</span><br><span class="line">+-----------------+</span><br><span class="line">| TRX_ID          |</span><br><span class="line">+-----------------+</span><br><span class="line">| 281479840930344 |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="mysql客户端2"><a href="#mysql客户端2" class="headerlink" title="mysql客户端2"></a>mysql客户端2</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;1&#39; where sno&#x3D;1;</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;1&#39; where sno&#x3D;2;</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;1&#39; where sno&#x3D;3;</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; insert into student values(0,&#39;0&#39;);</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; insert into student values(4,&#39;4&#39;);</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; insert into student values(11,&#39;11&#39;);</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br></pre></td></tr></table></figure>

<h5 id="mysql客户端3"><a href="#mysql客户端3" class="headerlink" title="mysql客户端3"></a>mysql客户端3</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.data_locks\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:1060:140371482961224</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 103</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: NULL</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371482961224</span><br><span class="line">            LOCK_TYPE: TABLE</span><br><span class="line">            LOCK_MODE: IS</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:3:4:1:140371501798424</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 103</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: PRIMARY</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501798424</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: supremum pseudo-record</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:3:4:2:140371501798424</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 103</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: PRIMARY</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501798424</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: 1</span><br><span class="line">*************************** 4. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:3:4:3:140371501798424</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 103</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: PRIMARY</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501798424</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: 2</span><br><span class="line">*************************** 5. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:3:4:4:140371501798424</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 103</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: PRIMARY</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501798424</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: 3</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从8.0起支持看锁的具体信息，8.0以前不支持，甚至都不存在data_locks这个表。</p>
<p>分析一下，第一个锁的是IS锁，表级锁定，LOCK_DATA是指锁定行的主键值，如果是表锁则为null。后面锁的分别是supremum pseudo-record，1，2，3。关于supremum pseudo-record，参考 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-next-key-locks。" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-next-key-locks。</a> 意思大概是间隙锁定义supremum pseudo-record为最大的上界。这样就大概清楚了原因，使用gap lock和net key lock将所有的行都锁住了，看起来好像是锁表，但是跟锁表不是一回事（真正的锁表是lock tables table_name read或者lock tables table_name write，table_name可以有多个，同时锁定多个表)。这里show的数据是mysql客户端1加锁后就查的，如果在mysql客户端2进行更新操作和插入操作后查会有很多的记录，在commit或者rollback后（事务操作结束）这些多出来的记录会消失。</p>
<h3 id="加索引（非唯一索引）"><a href="#加索引（非唯一索引）" class="headerlink" title="加索引（非唯一索引）"></a>加索引（非唯一索引）</h3><h5 id="mysql客户端1-1"><a href="#mysql客户端1-1" class="headerlink" title="mysql客户端1"></a>mysql客户端1</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; create index name on student(name);</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; desc student;</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| sno   | int(32)     | NO   | PRI | NULL    |       |</span><br><span class="line">| name  | varchar(32) | NO   | MUL | NULL    |       |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student where name&#x3D;2 lock in share mode;</span><br><span class="line">+-----+------+</span><br><span class="line">| sno | name |</span><br><span class="line">+-----+------+</span><br><span class="line">|   2 | 2    |</span><br><span class="line">+-----+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="mysql客户端3-1"><a href="#mysql客户端3-1" class="headerlink" title="mysql客户端3"></a>mysql客户端3</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.data_locks\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:1060:140371482961224</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 139</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: NULL</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371482961224</span><br><span class="line">            LOCK_TYPE: TABLE</span><br><span class="line">            LOCK_MODE: IS</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:3:5:1:140371501798424</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 139</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: name</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501798424</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: supremum pseudo-record</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:3:5:2:140371501798424</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 139</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: name</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501798424</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: &#39;1&#39;, 1</span><br><span class="line">*************************** 4. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:3:5:3:140371501798424</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 139</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: name</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501798424</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: &#39;2&#39;, 2</span><br><span class="line">*************************** 5. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864219688:3:5:4:140371501798424</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840930344</span><br><span class="line">            THREAD_ID: 48</span><br><span class="line">             EVENT_ID: 139</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: name</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501798424</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: &#39;3&#39;, 3</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>发现和无索引的时候差不多。</p>
<h5 id="mysql客户端2-1"><a href="#mysql客户端2-1" class="headerlink" title="mysql客户端2"></a>mysql客户端2</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;4&#39; where sno&#x3D;1;</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;4&#39; where sno&#x3D;2;</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;4&#39; where sno&#x3D;3;</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; insert into student value(0,&#39;0&#39;);</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; insert into student value(5,&#39;5&#39;);</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; insert into student value(11,&#39;11&#39;);</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br></pre></td></tr></table></figure>
<p>确实修改和插入失败，类似无索引一样。</p>
<p>到此，我们需要关心的是锁的策略，本次需要关注<strong>record lock</strong>，<strong>gap lock</strong>和<strong>next key lock</strong>。</p>
<p>record lock：记录锁，锁住索引记录本身，如果没有索引就锁聚集索引，如果没有聚集索引，mysql会自动隐示的创建聚集索引。</p>
<p>gap lock：间隙锁，锁住记录之间或者第一个记录之前或者最后一个记录之后，间隙可能跨越单个索引值，多个索引值，甚至空（null）。如果是使用唯一索引来锁定唯一行来锁定的语句，不需要间隙锁定（这不包括搜索条件仅包含多列唯一索引的某些列的情况；在这种情况下，会发生间隙锁定。因为不能确定是唯一的，已测试，确实如此）。个人理解是区间的左开右开。</p>
<p>next key lock：是record lock和gap lock的组合。即左开右闭，除了最后的supremum pseudo-record是左开右开。</p>
<h1 id="RC隔离级别"><a href="#RC隔离级别" class="headerlink" title="RC隔离级别"></a>RC隔离级别</h1><p>RC隔离级别禁用了间隙锁，可能会产生幻读的问题。</p>
<h5 id="mysql客户端1-2"><a href="#mysql客户端1-2" class="headerlink" title="mysql客户端1"></a>mysql客户端1</h5><p>无索引，加共享锁。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; desc student;</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| sno   | int(32)     | NO   | PRI | NULL    |       |</span><br><span class="line">| name  | varchar(32) | NO   |     | NULL    |       |</span><br><span class="line">| t     | varchar(32) | NO   |     | NULL    |       |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student where name&#x3D;&#39;2&#39; for share;</span><br><span class="line">+-----+------+---+</span><br><span class="line">| sno | name | t |</span><br><span class="line">+-----+------+---+</span><br><span class="line">|   2 | 2    |   |</span><br><span class="line">+-----+------+---+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<h6 id="mysql客户端3-2"><a href="#mysql客户端3-2" class="headerlink" title="mysql客户端3"></a>mysql客户端3</h6><p>没有对间隙进行加锁。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.data_locks\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864220544:1060:140371482963192</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840931200</span><br><span class="line">            THREAD_ID: 116</span><br><span class="line">             EVENT_ID: 38</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: NULL</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371482963192</span><br><span class="line">            LOCK_TYPE: TABLE</span><br><span class="line">            LOCK_MODE: IS</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: 4864220544:3:4:19:140371501803032</span><br><span class="line">ENGINE_TRANSACTION_ID: 281479840931200</span><br><span class="line">            THREAD_ID: 116</span><br><span class="line">             EVENT_ID: 38</span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: NULL</span><br><span class="line">    SUBPARTITION_NAME: NULL</span><br><span class="line">           INDEX_NAME: PRIMARY</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 140371501803032</span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S,REC_NOT_GAP</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: 2</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从锁的状态看是只锁了一行的记录，尝试修改和插入操作验证一下</p>
<h5 id="mysql客户端2-2"><a href="#mysql客户端2-2" class="headerlink" title="mysql客户端2"></a>mysql客户端2</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;10&#39; where sno&#x3D;2;</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;10&#39; where sno&#x3D;1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; update student set name&#x3D;&#39;10&#39; where sno&#x3D;3;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into student values(4,&#39;4&#39;,&#39;&#39;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>摘自官方文档</p>
<ul>
<li>READ COMMITTED</li>
</ul>
<p>Each consistent read, even within the same transaction, sets and reads its own fresh snapshot. For information about consistent reads, see Section 15.7.2.3, “Consistent Nonlocking Reads”.</p>
<p>For locking reads (SELECT with FOR UPDATE or FOR SHARE), UPDATE statements, and DELETE statements, InnoDB locks only index records, not the gaps before them, and thus permits the free insertion of new records next to locked records. Gap locking is only used for foreign-key constraint checking and duplicate-key checking.</p>
<p>Because gap locking is disabled, phantom problems may occur, as other sessions can insert new rows into the gaps. For information about phantoms, see Section 15.7.4, “Phantom Rows”.</p>
<p>Only row-based binary logging is supported with the READ COMMITTED isolation level. If you use READ COMMITTED with binlog_format=MIXED, the server automatically uses row-based logging.</p>
<p>Using READ COMMITTED has additional effects:</p>
<ul>
<li><p>For UPDATE or DELETE statements, InnoDB holds locks only for rows that it updates or deletes. Record locks for nonmatching rows are released after MySQL has evaluated the WHERE condition. This greatly reduces the probability of deadlocks, but they can still happen.</p>
</li>
<li><p>For UPDATE statements, if a row is already locked, InnoDB performs a “semi-consistent” read, returning the latest committed version to MySQL so that MySQL can determine whether the row matches the WHERE condition of the UPDATE. If the row matches (must be updated), MySQL reads the row again and this time InnoDB either locks it or waits for a lock on it.</p>
</li>
</ul>
<p>渣翻译：</p>
<p><font color='red'>即使在同一个事务中，每个一致性读取都将读取最新的快照。</font>（区别于RR级别下的读取，两个客户端进行事务操作，客户端1读取了快照，客户端2修改某些行并提交释放了锁，客户端重新读取快照会获得最新的快照数据，这里的区别似乎也正是幻读上的问题）</p>
<p>对于加锁的读（select带上for update或者for share），update和delete语句，InnoDB只会锁住索引记录，并不会在前面加上间隙锁，因此允许在锁定的记录周围插入记录。间隙锁定只用在外键约束检查和重复键检查。</p>
<p>由于禁用了间隙锁定，可能幻读的问题，因为其他会话可以插入新的记录到间隙中。</p>
<p>RC级别仅支持基于行的二进制日志。如果你使用RC级别并设置binlog_format=MIXED，服务器将会自动使用基于行的日志记录。</p>
<p>使用RC将会带来额外的影响：</p>
<ul>
<li><p>对于update或者delete语句，InnoDB只会锁住更新或者删除的行。在MySQL评估where条件后，会释放不匹配的行的record lock（这也是上面结果的原因，另外实际测试中似乎不是先锁，然后根据where条件释放不匹配的行，而是根据where条件锁住匹配的行，也可能是遍历每一条的行记录都是先加锁然后根据where条件选择是否释放锁。个人比较倾向后面的结果，在无索引的情况下，使用mysql客户端1对一行记录不通过索引列查找加X锁，mysql客户端2不通过索引进行另一行的查找加锁（X or S都行），发现客户端2在等待客户端1开启的事务的锁。）。这大大降低了死锁的可能性，但依然可以发生。</p>
</li>
<li><p>对于update语句，如果一行早已被锁住，InnoDB会执行“半一致”读取，将最新的提交版本返回给MySQL，以便MySQL能确认是否行符合where条件的update语句。如果行匹配（必须更新），MySQL会再次读取该行同时InnoDB对行进行锁定或者等待对行的锁定（应该是等待对行的锁定释放后就上锁啦）。</p>
</li>
</ul>
<p>对第一个结论，个人持不同的观点，或者说这样的写法容易让人误解，会以为是把所有记录都锁住了，然后根据where条件进行释放锁操作。个人猜测可能是遍历每一条的行记录，然后先加锁，再根据where条件选择是否释放锁（怀疑是where条件后才加锁，根本就没有释放锁的操作，test2验证）。以下测试都是在百万级的数据进行。</p>
<p>test1：在无索引的情况下，session1对一行记录不通过索引列查找加X锁，session2不通过索引进行另一行的查找加锁（X or S都行），发现session2在等待session1开启的事务的锁。而且过程中出现了一个神奇的情况，因为是根据无索引的列进行查找，则会通过cluster index（如果有主键，则cluster index是主键索引）的顺序进行查找，那么如果session1锁的行记录是比较小的记录，session2锁住的行是比较大的记录，那么session2在遍历的过程中就在等待session1锁中的记录，如果在这个过程中如果有session3通过cluster index索引到小于等于session2要锁的行的记录并加锁，这个操作会成功（在session2之后执行），session1释放锁后，session2会等待session3的锁。</p>
<p>test2：在无索引的情况下，对一条行记录进行非索引记录加锁查找，由于是百万级的数据，无索引查找非常的慢，过程中进行打印锁的信息，发现确实是进行了加锁操作，验证了是加锁然后释放锁。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/09/22/java%E7%9A%84volatile%E5%85%B3%E9%94%AE%E5%AD%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/java%E7%9A%84volatile%E5%85%B3%E9%94%AE%E5%AD%97/" class="post-title-link" itemprop="url">java的volatile关键字</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-22 10:20:41" itemprop="dateCreated datePublished" datetime="2020-09-22T10:20:41+08:00">2020-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>volatile保证可见行，有序性，不保证原子性。<br><br/></br><br>涉及的计算机知识：为了使得程序能够高速的运行，cpu会将内存中的值复制一份到高速缓冲区（Cache），后续直接使用Cache中的值。这种做法在单核cpu是ok，在多核cpu涉及多线程的操作时，就可能会出现数据不一致的情况。解决办法有：<br></br></br><br>（1）在总线上加LOCK#<br></br><br>（2）使用MESI缓存一致性协议<br></br></br><br>两种办法都是在硬件层面实现。早期的时候是使用第一种方法来解决，通过在总线上加锁，阻塞其他cpu对其他硬件的访问（如内存），直到当前cpu使用后释放锁，这样就保证了数据的一致性。但是这样的操作会出现同一时刻只有一个cpu访问内存，导致程序执行效率大大降低。<br></br></br><br>于是Intel推出了MESI缓存一致性协议。缓存一致性协议保证了所有cpu中的变量副本都是一致的，具体的实现是cpu写数据的时候，如果发现该变量是共享变量，会发出信号通知其他cpu将该变量置为失效，当其他cpu再次访问该变量时，发现变量失效了就会进入内存中获取最新的值。<br></br></br><br>JMM（java memory model）中规定所有的变量都是存在于主存，每个线程都有自己的工作内存（类似cpu中的Cache），线程只能操作自己的工作内存，不能访问和操作其他线程的工作内存。如果线程操作一个非共享变量，首先将变量从内存中拷贝到cpu的Cache中再进行操作。volatile实际上通过将变量标记为共享变量，被标记为共享的变量一旦被修改，就会强制更新内存，其他cpu在总线上通过嗅探这个变量的地址被改变就会将缓存该变量的缓存行设为无效，下次其他线程就会从内存中重新加载这个变量，这样就保证了数据的一致性。<br></br></br><br>先看一段代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static boolean flag &#x3D; false;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    Thread t &#x3D; new Thread(() -&gt; test());</span><br><span class="line">    t.start();</span><br><span class="line">    while (!flag) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void test() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F;停止100毫秒是为了保证子线程在主线程之后执行</span><br><span class="line">        Thread.sleep(100);</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    flag &#x3D; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码会进入死循环，新建线程对flag的修改对主线程并不可见，对flag用volatile修饰则能够解决死循环。<br></br></br><br>volatile解决有序性：volatile会禁止指令重排序，通过类似内存屏障的方式，在变量赋值后进行load addl $0x0, (%esp)操作。指令重排序的时候不能将后面的指令重排序到内存屏障之前的位置。<br></br></br><br>拓展的相关知识：false sharing（有关MESI），synchronized，lock。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/09/22/static%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E4%BF%AE%E9%A5%B0%E5%A4%96%E9%83%A8%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/static%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E4%BF%AE%E9%A5%B0%E5%A4%96%E9%83%A8%E7%B1%BB/" class="post-title-link" itemprop="url">static为什么不能修饰外部类</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-22 09:57:18" itemprop="dateCreated datePublished" datetime="2020-09-22T09:57:18+08:00">2020-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>static修饰的为类成员,会随着类的加载而加载,比如静态代码块,静态成员,静态方法(这里只是加载,并没有调用)等等,可以想象一下,如果把一个Class文件中的外部类设为static,目的难道是让这个类随着应用的启动而加载吗？如果在这次使用过程中根本没有使用过这个类,那么是不是就会浪费内存。这样来说设计不合理,总而言之,设计不合理的地方,Java是不会让它存在的。</p>
<p>而为什么内部类可以使用static修饰呢,因为内部类算是类的成员了,如果没有使用静态来修饰,那么在创建内部类的时候就需要先有一个外部类的对象,如果我们一直在使用内部类,那么内存中就会一直存在外部类的引用,而我们有时候只需要使用内部类,不需要外部类,那么还是会浪费内存,甚至会造成内存溢出。使用static修饰内部类之后,内部类在创建对象时就不需要有外部类对象的引用了。</p>
<p>结论:static可以用来修饰内部类,但是不可以用来修饰外部类</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/09/22/aop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/aop/" class="post-title-link" itemprop="url">aop</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-22 09:54:58" itemprop="dateCreated datePublished" datetime="2020-09-22T09:54:58+08:00">2020-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>aop概念：Aspect Oriented Programming，可以翻译成面向切面编程。</p>
<p>aop基础：aop是使用代理模式，通过反射技术动态的在运行时植入代码（定义切面，植入运行时代码）。动态植入的代码与被植入的代码段之间可以理解成是通过桥梁连接生成的，相比于继承体系的实现更加的解耦。</p>
<p>常见的aop应用：日志收集，权限校验等。</p>
<p>spring中的aop：定义了前置通知（before），后置通知（afterReturning），最终通知（after），异常通知（exception），环绕通知（Around)。方法执行顺序如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">try&#123;</span><br><span class="line">            try&#123;</span><br><span class="line">                doBefore();&#x2F;&#x2F;对应@Before注解的方法切面逻辑  </span><br><span class="line">                method.invoke();</span><br><span class="line">            &#125;finally&#123;</span><br><span class="line">                doAfter();&#x2F;&#x2F;对应@After注解的方法切面逻辑  </span><br><span class="line">            &#125;</span><br><span class="line">            doAfterReturning();&#x2F;&#x2F;对应@AfterReturning注解的方法切面逻辑  </span><br><span class="line">        &#125;catch(Exception e)&#123;</span><br><span class="line">            doAfterThrowing();&#x2F;&#x2F;对应@AfterThrowing注解的方法切面逻辑  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这段代码缺少了环绕通知，环绕通知是更为强大，可以重新定义上述的顺序，一般写了环绕通知就不需要再写其他的通知，统一管理。</p>
<p>基于注解的aop通知类AopLog，位于com.aop，注解里面的表达式是配置对哪些方法进行作用对，这里配置成拦截所有public的方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.aop;</span><br><span class="line"></span><br><span class="line">import org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line">import org.aspectj.lang.annotation.*;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">@Component(&quot;log&quot;)</span><br><span class="line">@Aspect</span><br><span class="line">public class AopLog &#123;</span><br><span class="line">    static long startTime &#x3D; 0;</span><br><span class="line">    static long endTime &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    @Before(&quot;execution(public * *(..))&quot;)</span><br><span class="line">    public void before() &#123;</span><br><span class="line">        System.out.println(&quot;前置通知&quot;);</span><br><span class="line">        startTime &#x3D; System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @AfterReturning(pointcut &#x3D; &quot;execution(public * *(..))&quot;)</span><br><span class="line">    public void afterReturn() &#123;</span><br><span class="line">        System.out.println(&quot;后置通知&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After(&quot;execution(public * *(..))&quot;)</span><br><span class="line">    public void after() &#123;</span><br><span class="line">        System.out.println(&quot;最终通知&quot;);</span><br><span class="line">        endTime &#x3D; System.currentTimeMillis();</span><br><span class="line">        System.out.println(startTime);</span><br><span class="line">        System.out.println(endTime);</span><br><span class="line">        System.out.println(&quot;耗时&quot; + (endTime - startTime) + &quot;毫秒&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @AfterThrowing(&quot;execution(public * *(..))&quot;)</span><br><span class="line">    public void myException() &#123;</span><br><span class="line">        System.out.println(&quot;异常&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Around(&quot;execution(public * *(..))&quot;)</span><br><span class="line">    public Object around(ProceedingJoinPoint pjp) &#123;</span><br><span class="line">        Object result &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F;可以在这里写入请求参数日志</span><br><span class="line">            System.out.println(&quot;before&quot;);</span><br><span class="line">            startTime &#x3D; System.currentTimeMillis();</span><br><span class="line">            &#x2F;&#x2F;目标方法的执行</span><br><span class="line">            result &#x3D; pjp.proceed();</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            &#x2F;&#x2F;可以在这里写入异常日志</span><br><span class="line">            System.out.println(&quot;exception&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            &#x2F;&#x2F;可以在这里统计接口耗时</span><br><span class="line">            System.out.println(&quot;after&quot;);</span><br><span class="line">            endTime &#x3D; System.currentTimeMillis();</span><br><span class="line">            System.out.println(startTime);</span><br><span class="line">            System.out.println(endTime);</span><br><span class="line">            System.out.println(&quot;耗时&quot; + (endTime - startTime) + &quot;毫秒&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>People类，位于com.bean，使用aop拦截print方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.bean;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">@Component(&quot;people&quot;)</span><br><span class="line">public class People &#123;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void print(String res)&#123;</span><br><span class="line">        &#x2F;&#x2F;测试异常</span><br><span class="line">&#x2F;&#x2F;        int a &#x3D; 1&#x2F;0;</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>applicationContext.xml配置文件，配置IOC和AOP等</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;</span><br><span class="line">       xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">       xmlns:aop&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop&quot;</span><br><span class="line">       xmlns:context&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context&quot;</span><br><span class="line">       xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans</span><br><span class="line">http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans.xsd</span><br><span class="line">http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context&#x2F;spring-context.xsd</span><br><span class="line">http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop&#x2F;spring-aop.xsd</span><br><span class="line">&quot;&gt;</span><br><span class="line">    &lt;!--开启AOP--&gt;</span><br><span class="line">    &lt;aop:aspectj-autoproxy&gt;&lt;&#x2F;aop:aspectj-autoproxy&gt;</span><br><span class="line">    &lt;!--指定IOC容器的扫描包--&gt;</span><br><span class="line">    &lt;context:component-scan base-package&#x3D;&quot;com.aop,com.bean&quot;&gt;&lt;&#x2F;context:component-scan&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;beans&gt;</span><br></pre></td></tr></table></figure>
<p>测试类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import com.bean.People;</span><br><span class="line">import com.bean.User;</span><br><span class="line">import org.springframework.context.ApplicationContext;</span><br><span class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line">public class AopTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        aopTest(&quot;aop&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void aopTest(String res) &#123;</span><br><span class="line">        ApplicationContext context &#x3D; new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);</span><br><span class="line">        People p &#x3D; (People) context.getBean(&quot;people&quot;);</span><br><span class="line">        p.print(&quot;aop&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释AopLog的环绕通知的代码运行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">前置通知</span><br><span class="line">aop</span><br><span class="line">最终通知</span><br><span class="line">1551160014037</span><br><span class="line">1551160014060</span><br><span class="line">耗时23毫秒</span><br><span class="line">后置通知</span><br></pre></td></tr></table></figure>
<p>注释AopLog除环绕通知之外的代码运行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">before</span><br><span class="line">aop</span><br><span class="line">after</span><br><span class="line">1551159843371</span><br><span class="line">1551159843396</span><br><span class="line">耗时25毫秒</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuxyzz.github.io/2020/09/22/java%E4%B8%AD%E7%9A%84%E2%80%9C%E9%9A%90%E8%97%8F%E2%80%9D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fuxyzz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuxyzz's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/java%E4%B8%AD%E7%9A%84%E2%80%9C%E9%9A%90%E8%97%8F%E2%80%9D/" class="post-title-link" itemprop="url">java中的“隐藏”</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-22 09:27:28" itemprop="dateCreated datePublished" datetime="2020-09-22T09:27:28+08:00">2020-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-29 11:01:12" itemprop="dateModified" datetime="2021-07-29T11:01:12+08:00">2021-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Parent&#123;</span><br><span class="line">    public static void print()&#123;</span><br><span class="line">        System.out.print(&quot;parent&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Son extends Parent&#123;</span><br><span class="line">    public static void print()&#123;</span><br><span class="line">        System.out.print(&quot;Son&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        Parent p &#x3D; new Son();</span><br><span class="line">        p.print();</span><br><span class="line">        &#x2F;&#x2F;输出parent</span><br><span class="line">        Son s &#x3D; new Son();</span><br><span class="line">        s.print();</span><br><span class="line">        &#x2F;&#x2F;输出son</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>理解继承的本质：为何与非静态方法调用的方法不一致？其实是因为设计上的原因，静态方法本身是为了不创建实例就能够直接使用的方法（例如Parent.print()），而且静态方法本质上是类方法，只属于本类，不应该被继承。于是继承的时候这个方法不能被重写（overwrite），而是被隐藏。此时应该是由句柄决定调用的是父类还是子类的方法。其实非静态方法也是如此，父类方法被重写了，最终句柄指向的方法就是被重写的方法。</p>
<p>结论：所有对象调用的方法是根据句柄来决定的，看透本质即可（了解隐藏，重写的实际运作）。</p>
<p>注：这也是静态绑定，final，static，private等方法都是这样的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fuxyzz</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  















  

  

</body>
</html>
